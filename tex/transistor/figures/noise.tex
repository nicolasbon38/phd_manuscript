%!TeX root = ../../../thesis.tex
\def\yPseudoKS{-3}

\begin{figure}[t!]
  \centering
    \footnotesize
    \begin{tikzpicture} [xscale=1,yscale=0.45]
      % LFSR interactions
      \draw (-1, \yPseudoKS) rectangle ++(3, 1) node[pos=0.5]{$\pseudoKS$ {\tiny \emph{(Key Schedule)}}} ;
      \draw (-1, 2.5) rectangle (2, 3.5) node[pos=0.5]{$\whitening$ {\tiny \emph{(whitening LFSR)}}} ;
      \draw (3.5, \yPseudoKS + 0.5) node[inner sep=0pt](addm){$\boxplus$} ;

      \node at (0.5, \yPseudoKS - 1) {$\sigma_{\text{fresh}}^{2}$};
      \node at (0.5, \yPseudoKS - 2.5) {\scalebox{0.5}{\verticalgauge{10}}};
      \node at (0.5, 2) {$\sigma_{\text{fresh}}^{2}$};
      \node at (0.5, 0.5) {\scalebox{0.5}{\verticalgauge{10}}};

      \draw (2.7, \yPseudoKS) node[inner sep=0pt](varKS){$\sigma_\pseudoKS^2$} ;
      \node at ($(varKS.south) + (0, -1)$) {\scalebox{0.5}{\verticalgauge{30}}};
      
      \draw (4.5, 3.5) node[inner sep=0pt](varW){$\sigma_\whitening^2$} ;
      \node at ($(varW.north) + (0, 1)$) {\scalebox{0.5}{\verticalgauge{30}}};
      \draw (7, \yPseudoKS) node[inner sep=0pt](varPBS){$\sigma_{\text{PBS}}^2$} ;
       \node at ($(varPBS.south) + (0, -1)$) {\scalebox{0.5}{\verticalgauge{50}}};
      \draw (9.7,\yPseudoKS) node[inner sep=0pt](varSR){$\sigma_{\text{PBS}}^2$} ;
      \node at ($(varSR.south) + (0, -1)$) {\scalebox{0.5}{\verticalgauge{50}}};
      \draw (8, 2 * \yPseudoKS - 1) node[inner sep=0pt](varMC){$\sigma^2_\mixC$} ;
      \node at ($(varMC.south) + (0, -1)$) {\scalebox{0.5}{\verticalgauge{70}}};
      \draw (4.35, \yPseudoKS + 1.5) node(sum) {$\sigma_\pseudoKS^2+\sigma^2_\mixC$};
      \node at ($(sum.south) + (0, 2)$) {\scalebox{0.5}{\verticalgauge{70}}};
      \draw (9, 3.5) node[inner sep=0pt](varout){$\sigma^2_{\text{out}}  = \sigma_\whitening^2 + \sigma_{\text{PBS}}^2$} ;
      \node at ($(varout.north) + (0, 1)$) {\scalebox{0.5}{\verticalgauge{50}}};

      \draw[->] (2, \yPseudoKS + 0.5) -- (addm) ;
      \draw[->] (2.5, \yPseudoKS + 0.5) -- (2.5, \yPseudoKS + 1.5) -- (0.5, \yPseudoKS + 1.5) -- (0.5, \yPseudoKS + 1) ;
      \draw[->] (2.5, 3) -- (2.5, 4) -- (0.5, 4) -- (0.5, 3.5) ;
      % FSM
      \draw[color=blue,style=dashed] (5, \yPseudoKS) rectangle ++(1, 1) node[pos=0.5]{$\subW$} ;
      \draw (8, \yPseudoKS) rectangle ++(1, 1) node[pos=0.5]{$\shiftR$} ;
      \draw (10.3, \yPseudoKS) rectangle ++(1, 1) node[pos=0.5]{$\mixC$} ;
      \draw[->] (addm) -- (5, \yPseudoKS + 0.5) ;
      \draw[->] (6, \yPseudoKS + 0.5) -- (8, \yPseudoKS + 0.5) ;
      \draw[->] (9, \yPseudoKS + 0.5) -- (10.3, \yPseudoKS + 0.5) ;
      \draw[->] (11.3, \yPseudoKS + 0.5) -- (11.6, \yPseudoKS + 0.5) -- (11.6, 2 * \yPseudoKS - 0.5) --  (3.5, 2 * \yPseudoKS - 0.5) -- (addm) ;
      % extracting
      \draw (6.5, \yPseudoKS + 3) rectangle ++(1, 1) node[pos=0.5]{$\filter$} ;
      \draw (7, 3) node[inner sep=0pt](addr){$\boxplus$};
      \draw(11.3, 3) node(s){$Z_i$} ;
      \draw[->] (2, 3) -- (addr) ;
      \draw[->] (7, \yPseudoKS + 0.5) -- (7, \yPseudoKS + 3) ;
      \draw[->] (7, \yPseudoKS + 4) -- (addr) ;
      \draw[->] (addr) -- (s) ;
      % wire width
      % \draw (4.45, -0.2) -- (4.55, 0.2) ;
      % \draw (4.5, -0.5) node{$m$} ;
      % \draw[color=lightgray] (4.45, 2.8) -- (4.55, 3.2) ;
      % \draw[color=lightgray] (4.5, 3.5) node{$r$} ;
    \end{tikzpicture}
    \caption{Evolution of the noise variance in a homomorphic evaluation of \coolName. Operations involving PBSs are in blue and dashed. The gauges allow to visualize the evolution of the noise on a logarithmic scale).}
    \label{fig:noise}
\end{figure}




